import os
import uuid
import pyshark

output_dir = "output_images"
os.makedirs(output_dir, exist_ok=True)


def extract_http_images(pcap_file):
    # Open the PCAP file using PyShark
    cap = pyshark.FileCapture(pcap_file, display_filter="http")

    # Iterate through the packets
    for packet in cap:
        try:
            if "HTTP" in packet and hasattr(packet.http, "response_code"):
                content_type = packet.http.content_type
                if content_type.startswith("image") and hasattr(
                    packet.http, "file_data"
                ):
                    image_data = packet.http.file_data.binary_value
                    file_name = f"{uuid.uuid4().hex}.png"
                    output_path = os.path.join(output_dir, file_name)
                    with open(output_path, "wb") as img_file:
                        img_file.write(image_data)
                    print(f"Image saved as: {output_path}")

        except AttributeError:
            continue


# Replace with your pcap file path
pcap_file = "./ctf_traffic.pcap"
extract_http_images(pcap_file)
