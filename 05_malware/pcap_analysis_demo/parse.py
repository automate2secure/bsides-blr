import pyshark
from collections import Counter

pcap_file = './c1.pcap'

capture = pyshark.FileCapture(pcap_file, display_filter='http')
total_packets = 0
protocols = Counter()
http_hosts = Counter()
http_uris = Counter()
user_agents = Counter()
src_ips = Counter()
dst_ips = Counter()

for packet in capture:
    total_packets += 1
    # Count protocols
    try:
        proto = packet.highest_layer
        protocols[proto] += 1
    except AttributeError:
        continue

    # IP addresses
    if hasattr(packet, 'ip'):
        src_ips[packet.ip.src] += 1
        dst_ips[packet.ip.dst] += 1

    # HTTP-specific analysis
    if 'HTTP' in packet:
        if hasattr(packet.http, 'host'):
            http_hosts[packet.http.host] += 1
        if hasattr(packet.http, 'request_uri'):
            http_uris[packet.http.request_uri] += 1
        if hasattr(packet.http, 'user_agent'):
            user_agents[packet.http.user_agent] += 1

capture.close()

print(f"Total packets: {total_packets}")
print("Protocol distribution:", protocols)
print("Top source IPs:", src_ips.most_common(5))
print("Top destination IPs:", dst_ips.most_common(5))
print("Top HTTP hosts:", http_hosts.most_common(5))
print("Top HTTP URIs:", http_uris.most_common(5))
print("Top User-Agents:", user_agents.most_common(5))
